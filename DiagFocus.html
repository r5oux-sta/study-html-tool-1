<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DiagFocus - iPad Version</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Roboto+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            /* Color Palette */
            --color-bg-dark: #0f172a;
            /* Slate 900 */
            --color-bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --color-surface: rgba(30, 41, 59, 0.7);
            /* Glass effect base */
            --color-surface-border: rgba(255, 255, 255, 0.1);

            --color-primary: #3b82f6;
            /* Blue 500 */
            --color-primary-hover: #2563eb;
            --color-accent: #eab308;
            /* Yellow 500 (Gold-ish) */

            --color-text-main: #f8fafc;
            /* Slate 50 */
            --color-text-muted: #94a3b8;
            /* Slate 400 */

            --font-main: 'Noto Sans JP', sans-serif;
            --font-mono: 'Roboto Mono', monospace;

            --shadow-card: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            --radius-lg: 16px;
            --radius-sm: 8px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-main);
            background: var(--color-bg-dark);
            background-image: var(--color-bg-gradient);
            color: var(--color-text-main);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            /* overflow: hidden; Removed to allow scrolling on mobile if needed */
        }

        /* Background Abstract decoration */
        .background-overlay {
            position: fixed;
            /* Changed to fixed so it stays put */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(circle at 10% 20%, rgba(59, 130, 246, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(234, 179, 8, 0.1) 0%, transparent 40%);
        }

        .app-container {
            width: 100%;
            max-width: 1200px;
            /* Wider for dashboard */
            padding: 20px;
        }

        /* Dashboard Grid */
        .dashboard-layout {
            display: grid;
            grid-template-columns: 1fr 1.5fr 1fr;
            /* Left, Center (Wider), Right */
            gap: 20px;
            align-items: start;
        }

        @media (max-width: 900px) {
            .dashboard-layout {
                grid-template-columns: 1fr;
                /* Stack on smaller screens */
                max-width: 600px;
                margin: 0 auto;
            }

            .col-center {
                order: -1;
                /* Main timer on top in mobile view */
            }
        }

        /* Glass Card Common Style */
        .card-glass {
            background: var(--color-surface);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--color-surface-border);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-card);
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-height: 300px;
            /* Minimum height for symmetry */
        }

        /* Section Titles */
        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--color-accent);
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--color-surface-border);
            padding-bottom: 8px;
        }

        /* --- Left Col: Task Memo --- */
        .task-input-area {
            display: flex;
            gap: 8px;
        }

        #taskInput {
            flex: 1;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--color-surface-border);
            border-radius: var(--radius-sm);
            padding: 8px 12px;
            color: var(--color-text-main);
            font-family: var(--font-main);
        }

        #taskInput:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .btn-icon {
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            width: 40px;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover {
            background: var(--color-primary-hover);
        }

        .task-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 400px;
            /* Max height for scroll */
            min-height: 200px;
            /* Min height to easy drag */
            overflow-y: auto;
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--radius-sm);
            transition: background 0.2s;
            /* transition 'all' might conflict with drag movement visual flow? keep simple */
        }

        .task-item:hover {
            background: rgba(255, 255, 255, 0.06);
        }

        /* Emphasize the first task */
        .task-item:first-child {
            background: rgba(59, 130, 246, 0.1);
            /* Slight blue tint */
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .task-item:first-child .task-text {
            font-size: 1.15rem;
            /* ~4pt larger than 0.9rem (approx) */
            font-weight: 700;
            color: var(--color-accent);
        }

        /* Drag Handle */
        .drag-handle {
            cursor: grab;
            color: var(--color-text-muted);
            font-size: 1.2rem;
            padding: 0 4px;
            /* Reduced padding a bit */
            user-select: none;
            line-height: 1;
        }

        .drag-handle:active {
            cursor: grabbing;
            color: var(--color-primary);
        }

        .task-item.dragging {
            opacity: 0.5;
            border: 1px dashed var(--color-primary);
        }

        .task-item.over {
            border-bottom: 2px solid var(--color-accent);
        }

        .task-checkbox {
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        .task-text {
            flex: 1;
            font-size: 0.9rem;
            word-break: break-all;
        }

        .task-item.completed .task-text {
            text-decoration: line-through;
            color: var(--color-text-muted);
        }

        .task-delete {
            background: transparent;
            border: none;
            color: var(--color-text-muted);
            cursor: pointer;
            font-size: 0.8rem;
            padding: 4px;
            margin-left: 4px;
        }

        .task-delete:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            /* Red */
            border-radius: 4px;
        }


        /* --- Right Col: Pomodoro --- */
        .pomo-display {
            text-align: center;
            margin: 16px 0;
        }

        .pomo-timer {
            font-family: var(--font-mono);
            font-size: 3rem;
            font-weight: 700;
            color: var(--color-text-main);
        }

        .pomo-status {
            font-size: 0.9rem;
            color: var(--color-text-muted);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .pomo-controls {
            display: flex;
            gap: 8px;
        }

        .pomo-presets {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 8px;
        }

        /* --- Center Col Modifications --- */
        .main-header {
            text-align: center;
        }

        .date-display {
            font-size: 0.9rem;
            color: var(--color-text-muted);
            margin-bottom: 4px;
            letter-spacing: 0.05em;
        }

        .clock-display {
            font-family: var(--font-mono);
            font-size: 3.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            background: linear-gradient(to bottom, #fff, #cbd5e1);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* Main Card (Replaced by card-glass in grid) */
        /* Kept clean for safety */

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            background: rgba(0, 0, 0, 0.2);
            padding: 4px;
            border-radius: var(--radius-sm);
        }

        .tab-btn {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--color-text-muted);
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-family: var(--font-main);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: rgba(255, 255, 255, 0.1);
            color: var(--color-text-main);
            font-weight: 600;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 24px;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .time-display.large {
            font-family: var(--font-mono);
            font-size: 4rem;
            font-weight: 400;
            color: var(--color-text-main);
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 16px;
            width: 100%;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: var(--font-main);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--color-primary-hover);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--color-surface-border);
            color: var(--color-text-muted);
        }

        .btn-outline:hover:not(:disabled) {
            border-color: var(--color-text-muted);
            color: var(--color-text-main);
        }

        /* Timer Presets */
        .timer-presets {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .chip {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--color-surface-border);
            color: var(--color-text-muted);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chip:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--color-text-main);
        }

        /* Footer Stats */
        .stats-footer {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 12px;
            text-align: center;
            padding-top: 12px;
            border-top: 1px solid var(--color-surface-border);
            align-items: center;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .stat-value {
            font-family: var(--font-mono);
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-accent);
        }

        .stat-divider {
            width: 1px;
            height: 24px;
            background: var(--color-surface-border);
        }

        .quote-area {
            grid-column: 1 / -1;
            font-size: 0.8rem;
            color: var(--color-text-muted);
            font-style: italic;
            opacity: 0.8;
            margin-top: 8px;
        }
    </style>
</head>

<body>
    <div class="background-overlay"></div>

    <div class="app-container dashboard-layout">

        <!-- Left Column: Task Memo -->
        <aside class="dashboard-col col-left card-glass">
            <h2 class="section-title">TODO List</h2>
            <div class="task-input-area">
                <input type="text" id="taskInput" placeholder="Add a task..." />
                <button class="btn-icon" id="addTaskBtn">+</button>
            </div>
            <ul class="task-list" id="taskList">
                <!-- Tasks will be injected here -->
            </ul>
        </aside>

        <!-- Center Column: Main Timer (Existing) -->
        <main class="dashboard-col col-center card-glass">
            <!-- Header / Clock Section -->
            <header class="main-header">
                <div class="date-display" id="dateDisplay">2024.01.01 (Mon)</div>
                <div class="clock-display" id="clockDisplay">00:00:00</div>
            </header>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" data-tab="stopwatch">学習記録</button>
                <button class="tab-btn" data-tab="timer">演習タイマー</button>
            </div>

            <!-- Content Area: Stopwatch -->
            <div class="tab-content active" id="stopwatch">
                <div class="time-display large" id="stopwatchDisplay">00:00:00</div>
                <div class="controls">
                    <button class="btn btn-primary" id="swStartBtn">START</button>
                    <button class="btn btn-secondary" id="swPauseBtn" disabled>PAUSE</button>
                    <button class="btn btn-outline" id="swResetBtn" disabled>RESET</button>
                </div>
            </div>

            <!-- Content Area: Timer -->
            <div class="tab-content" id="timer">
                <div class="timer-presets">
                    <button class="chip" data-time="60">60分</button>
                    <button class="chip" data-time="80">80分</button>
                    <button class="chip" data-time="90">90分</button>
                    <button class="chip" data-time="custom">カスタム</button>
                </div>
                <div class="time-display large" id="timerDisplay">60:00</div>
                <div class="controls">
                    <button class="btn btn-primary" id="tmStartBtn">START</button>
                    <button class="btn btn-secondary" id="tmPauseBtn" disabled>PAUSE</button>
                    <button class="btn btn-outline" id="tmResetBtn">RESET</button>
                </div>
            </div>

            <!-- Motivation / Stats Footer -->
            <footer class="stats-footer">
                <div class="stat-item">
                    <span class="stat-label">TODAY</span>
                    <span class="stat-value" id="todayTotal">0h 00m</span>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-item">
                    <span class="stat-label">TOTAL</span>
                    <span class="stat-value" id="grandTotal">0h 00m</span>
                </div>
                <div class="quote-area" id="quoteDisplay">
                    "Small steps every day."
                </div>
            </footer>
        </main>

        <!-- Right Column: Pomodoro -->
        <aside class="dashboard-col col-right card-glass">
            <h2 class="section-title">Pomodoro</h2>
            <div class="pomo-display">
                <div class="pomo-timer" id="pomoDisplay">25:00</div>
                <div class="pomo-status" id="pomoStatus">Focus Time</div>
            </div>
            <div class="pomo-controls">
                <button class="btn btn-primary" id="pomoStartBtn">START</button>
                <button class="btn btn-outline" id="pomoResetBtn">RESET</button>
            </div>
            <div class="pomo-presets">
                <button class="chip" id="pomoFocusBtn">25m Focus</button>
                <button class="chip" id="pomoBreakBtn">5m Break</button>
            </div>
        </aside>

    </div>

    <script>
        /**
         * DiagFocus - Application Logic
         */

        document.addEventListener('DOMContentLoaded', () => {
            // === DOM Elements ===
            const dateDisplay = document.getElementById('dateDisplay');
            const clockDisplay = document.getElementById('clockDisplay');

            // Tabs
            const tabs = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            // Stopwatch
            const stopwatchDisplay = document.getElementById('stopwatchDisplay');
            const swStartBtn = document.getElementById('swStartBtn');
            const swPauseBtn = document.getElementById('swPauseBtn');
            const swResetBtn = document.getElementById('swResetBtn');

            // Timer
            const timerDisplay = document.getElementById('timerDisplay');
            const tmStartBtn = document.getElementById('tmStartBtn');
            const tmPauseBtn = document.getElementById('tmPauseBtn');
            const tmResetBtn = document.getElementById('tmResetBtn');
            const presetChips = document.querySelectorAll('.chip[data-time]'); // Only select timer preset chips

            // Stats
            const todayTotalDisplay = document.getElementById('todayTotal');
            const grandTotalDisplay = document.getElementById('grandTotal');
            const quoteDisplay = document.getElementById('quoteDisplay');

            // Task Memo Elements
            const taskInput = document.getElementById('taskInput');
            const addTaskBtn = document.getElementById('addTaskBtn');
            const taskList = document.getElementById('taskList');

            // Pomodoro Elements
            const pomoDisplay = document.getElementById('pomoDisplay');
            const pomoStatus = document.getElementById('pomoStatus');
            const pomoStartBtn = document.getElementById('pomoStartBtn');
            const pomoResetBtn = document.getElementById('pomoResetBtn');
            const pomoFocusBtn = document.getElementById('pomoFocusBtn');
            const pomoBreakBtn = document.getElementById('pomoBreakBtn');

            // === State & Constants ===
            const STORAGE_KEY = 'diagfocus_data';
            const TASKS_KEY = 'diagfocus_tasks';
            let appData = {
                lastDate: new Date().toDateString(),
                todayMs: 0,
                totalMs: 0
            };

            // Stopwatch State
            let swInterval = null;
            let swStartTime = 0;
            let swElapsedTime = 0;

            // Timer State
            let tmInterval = null;
            let tmRemainingTime = 60 * 60 * 1000; // Default 60 mins
            let tmTotalDuration = 60 * 60 * 1000; // For tracking progress if needed
            let isTimerRunning = false;

            // === Helper Functions ===
            function formatTime(ms) {
                const totalSeconds = Math.floor(ms / 1000);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;

                if (hours > 0) {
                    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                }
                return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }

            function formatDuration(ms) {
                const totalMinutes = Math.floor(ms / (1000 * 60));
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                return `${hours}h ${String(minutes).padStart(2, '0')}m`;
            }

            function loadData() {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    // Check if it's a new day
                    const todayStr = new Date().toDateString();
                    if (parsed.lastDate !== todayStr) {
                        appData.lastDate = todayStr;
                        appData.todayMs = 0; // Reset today
                        appData.totalMs = parsed.totalMs || 0;
                    } else {
                        appData = parsed;
                    }
                }
                updateStatsDisplay();
            }

            function saveData() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
                updateStatsDisplay();
            }

            function updateStatsDisplay() {
                todayTotalDisplay.textContent = formatDuration(appData.todayMs);
                grandTotalDisplay.textContent = formatDuration(appData.totalMs);
            }

            function addStudyTime(ms) {
                appData.todayMs += ms;
                appData.totalMs += ms;
                saveData();
            }

            function playAlarm() {
                // Simple Beep
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.type = 'sine';
                osc.frequency.value = 880; // A5
                osc.start();

                gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 1);
                osc.stop(ctx.currentTime + 1);

                // Visual flash
                document.body.style.backgroundColor = 'var(--color-accent)';
                setTimeout(() => {
                    document.body.style.backgroundColor = '';
                }, 500);
            }

            // === Clock Functionality ===
            function updateClock() {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-GB', {
                    hour12: false
                });
                clockDisplay.textContent = timeStr;

                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const dateStr = `${now.getFullYear()}.${String(now.getMonth() + 1).padStart(2, '0')}.${String(now.getDate()).padStart(2, '0')} (${days[now.getDay()]})`;
                dateDisplay.textContent = dateStr;
            }
            setInterval(updateClock, 1000);
            updateClock();

            // === Tab Switching ===
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));

                    tab.classList.add('active');
                    const targetId = tab.dataset.tab;
                    document.getElementById(targetId).classList.add('active');
                });
            });

            // === Stopwatch Logic ===
            function updateSwDisplay() {
                stopwatchDisplay.textContent = formatTime(swElapsedTime);
            }

            swStartBtn.addEventListener('click', () => {
                if (!swInterval) {
                    swStartTime = Date.now() - swElapsedTime;
                    swInterval = setInterval(() => {
                        swElapsedTime = Date.now() - swStartTime;
                        updateSwDisplay();
                    }, 100);

                    swStartBtn.disabled = true;
                    swPauseBtn.disabled = false;
                    swResetBtn.disabled = true;
                    swStartBtn.textContent = 'RUNNING...';
                }
            });

            swPauseBtn.addEventListener('click', () => {
                if (swInterval) {
                    clearInterval(swInterval);
                    swInterval = null;

                    const currentSessionTime = swElapsedTime - swLastCreditedTime;
                    if (currentSessionTime > 0) {
                        addStudyTime(currentSessionTime);
                        swLastCreditedTime = swElapsedTime;
                    }

                    swStartBtn.disabled = false;
                    swPauseBtn.disabled = true;
                    swResetBtn.disabled = false;
                    swStartBtn.textContent = 'RESUME';
                }
            });

            let swLastCreditedTime = 0; // Track how much we've already added to stats from this run

            swResetBtn.addEventListener('click', () => {
                if (swInterval) clearInterval(swInterval);
                swInterval = null;

                const remaining = swElapsedTime - swLastCreditedTime;
                if (remaining > 0) {
                    addStudyTime(remaining);
                }

                swElapsedTime = 0;
                swLastCreditedTime = 0;
                updateSwDisplay();

                swStartBtn.disabled = false;
                swPauseBtn.disabled = true;
                swResetBtn.disabled = true;
                swStartBtn.textContent = 'START';
            });

            // === Timer Logic ===
            function updateTmDisplay() {
                timerDisplay.textContent = formatTime(tmRemainingTime);
            }

            tmStartBtn.addEventListener('click', () => {
                if (!tmInterval && tmRemainingTime > 0) {
                    const now = Date.now();
                    const targetTime = now + tmRemainingTime;

                    tmInterval = setInterval(() => {
                        const current = Date.now();
                        const leftover = targetTime - current;

                        if (leftover <= 0) {
                            clearInterval(tmInterval);
                            tmInterval = null;
                            tmRemainingTime = 0;
                            updateTmDisplay();
                            playAlarm();

                            addStudyTime(tmStartRemaining - 0); // All done
                            tmStartRemaining = 0; // Reset

                            tmStartBtn.disabled = false;
                            tmPauseBtn.disabled = true;
                            tmStartBtn.textContent = 'START';
                            alert('Time is up!');
                        } else {
                            tmRemainingTime = leftover;
                            updateTmDisplay();
                        }
                    }, 100);

                    tmStartRemaining = tmRemainingTime; // Snapshot for stats calc
                    isTimerRunning = true;

                    tmStartBtn.disabled = true;
                    tmPauseBtn.disabled = false;
                    tmResetBtn.disabled = true;
                }
            });

            let tmStartRemaining = 0; // Variable to help calculate elapsed time during a running session

            tmPauseBtn.addEventListener('click', () => {
                if (tmInterval) {
                    clearInterval(tmInterval);
                    tmInterval = null;

                    const timeSpent = tmStartRemaining - tmRemainingTime;
                    if (timeSpent > 0) {
                        addStudyTime(timeSpent);
                    }
                    tmStartRemaining = tmRemainingTime;

                    tmStartBtn.disabled = false;
                    tmPauseBtn.disabled = true;
                    tmResetBtn.disabled = false;
                }
            });

            tmResetBtn.addEventListener('click', () => {
                if (tmInterval) {
                    clearInterval(tmInterval);
                    tmInterval = null;
                    const timeSpent = tmStartRemaining - tmRemainingTime;
                    if (timeSpent > 0 && isTimerRunning) {
                        addStudyTime(timeSpent);
                    }
                }

                tmRemainingTime = tmSetTime;
                updateTmDisplay();

                tmStartBtn.disabled = false;
                tmPauseBtn.disabled = true;
                tmResetBtn.disabled = true; // Can't reset if already at start
            });

            let tmSetTime = 60 * 60 * 1000; // Value to return to on Reset

            presetChips.forEach(chip => {
                chip.addEventListener('click', () => {
                    const val = chip.dataset.time;
                    if (val === 'custom') {
                        const input = prompt('時間を分単位で入力してください', '60');
                        if (input && !isNaN(input)) {
                            tmSetTime = parseInt(input) * 60 * 1000;
                            tmRemainingTime = tmSetTime;
                            tmTotalDuration = tmSetTime;
                            updateTmDisplay();
                        }
                    } else {
                        tmSetTime = parseInt(val) * 60 * 1000;
                        tmRemainingTime = tmSetTime;
                        tmTotalDuration = tmSetTime;
                        updateTmDisplay();
                    }
                    if (tmInterval) clearInterval(tmInterval);
                    tmInterval = null;
                    tmStartBtn.disabled = false;
                    tmPauseBtn.disabled = true;
                    tmResetBtn.disabled = true;
                });
            });

            // quotes
            const quotes = [
                "Small steps every day.",
                "The best way to predict the future is to create it.",
                "Quality means doing it right when no one is looking.",
                "It always seems impossible until it's done.",
                "Don't watch the clock; do what it does. Keep going."
            ];
            quoteDisplay.textContent = quotes[Math.floor(Math.random() * quotes.length)];

            // Initialize
            loadData();
            loadTasks();
            updateSwDisplay();
            updateTmDisplay();

            // === Task Memo Logic (Drag & Drop) ===
            function loadTasks() {
                const saved = localStorage.getItem(TASKS_KEY);
                if (saved) {
                    const tasks = JSON.parse(saved);
                    renderTaskList(tasks);
                }
            }

            function saveTasks(tasksToSave) {
                if (!tasksToSave) {
                    // Reconstruct from DOM
                    tasksToSave = [];
                    document.querySelectorAll('.task-item').forEach(item => {
                        tasksToSave.push({
                            text: item.querySelector('.task-text').textContent,
                            completed: item.querySelector('.task-checkbox').checked
                        });
                    });
                }
                localStorage.setItem(TASKS_KEY, JSON.stringify(tasksToSave));
            }

            function renderTaskList(tasks) {
                taskList.innerHTML = '';
                tasks.forEach((task, index) => {
                    taskList.appendChild(createTaskElement(task, index));
                });
            }

            function createTaskElement(taskObj, index) {
                const li = document.createElement('li');
                li.className = `task-item ${taskObj.completed ? 'completed' : ''}`;
                li.draggable = true;

                // Drag Handle
                const handle = document.createElement('span');
                handle.className = 'drag-handle';
                handle.innerHTML = '≡';

                // Checkbox
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'task-checkbox';
                checkbox.checked = taskObj.completed;
                checkbox.addEventListener('change', () => {
                    li.classList.toggle('completed');
                    saveTasks();
                });

                // Text
                const span = document.createElement('span');
                span.className = 'task-text';
                span.textContent = taskObj.text;

                // Delete Button
                const delBtn = document.createElement('button');
                delBtn.className = 'task-delete';
                delBtn.innerHTML = '✕';
                delBtn.addEventListener('click', () => {
                    li.remove();
                    saveTasks();
                });

                li.appendChild(handle);
                li.appendChild(checkbox);
                li.appendChild(span);
                li.appendChild(delBtn);

                addDragEvents(li);

                return li;
            }

            // Drag & Drop Handlers
            let dragSrcEl = null;

            function addDragEvents(item) {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragenter', handleDragEnter);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('dragleave', handleDragLeave);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
            }

            function handleDragStart(e) {
                this.classList.add('dragging');
                dragSrcEl = this;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', this.innerHTML);
            }

            function handleDragOver(e) {
                if (e.preventDefault) {
                    e.preventDefault();
                }
                e.dataTransfer.dropEffect = 'move';
                return false;
            }

            function handleDragEnter(e) {
                this.classList.add('over');
            }

            function handleDragLeave(e) {
                this.classList.remove('over');
            }

            function handleDrop(e) {
                if (e.stopPropagation) {
                    e.stopPropagation();
                }

                if (dragSrcEl !== this) {
                    // Swap DOM logic: reorder based on position
                    const list = taskList;
                    const allItems = [...list.querySelectorAll('.task-item')];
                    const srcIndex = allItems.indexOf(dragSrcEl);
                    const targetIndex = allItems.indexOf(this);

                    if (srcIndex < targetIndex) {
                        this.after(dragSrcEl);
                    } else {
                        this.before(dragSrcEl);
                    }
                    saveTasks();
                }
                return false;
            }

            function handleDragEnd(e) {
                this.classList.remove('dragging');
                let items = taskList.querySelectorAll('.task-item');
                items.forEach(function (item) {
                    item.classList.remove('over');
                });
            }

            function addTask(text) {
                if (!text.trim()) return;
                const saved = localStorage.getItem(TASKS_KEY);
                const tasks = saved ? JSON.parse(saved) : [];
                tasks.push({
                    text: text,
                    completed: false
                });
                renderTaskList(tasks);
                saveTasks(tasks);
                taskInput.value = '';
            }

            addTaskBtn.addEventListener('click', () => addTask(taskInput.value));
            taskInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addTask(taskInput.value);
            });

            // === Pomodoro Logic ===
            let pomoInterval = null;
            let pomoTime = 25 * 60; // seconds
            let pomoTimeLeft = 25 * 60;

            // Status tracking for Auto-Switch
            // 'focus' = 25min, 'break' = 5min, 'custom' = others
            let pomoCurrentMode = 'focus';

            function updatePomoDisplay() {
                const m = Math.floor(pomoTimeLeft / 60);
                const s = pomoTimeLeft % 60;
                pomoDisplay.textContent = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            }

            function startPomoBreak() {
                pomoCurrentMode = 'break';
                pomoTime = 5 * 60;
                pomoTimeLeft = pomoTime;
                pomoStatus.textContent = 'Break Time';
                pomoStatus.style.color = 'var(--color-accent)';

                updatePomoDisplay();
                playAlarm();
                alert('Focus Session Complete! Starting 5m Break...');
                startPomoInterval();
            }

            function finishPomoBreak() {
                clearInterval(pomoInterval);
                pomoInterval = null;
                playAlarm();
                alert('Break Finished! Ready for next Focus?');

                pomoCurrentMode = 'focus';
                pomoTime = 25 * 60;
                pomoTimeLeft = pomoTime;
                pomoStatus.textContent = 'Focus Time';
                pomoStatus.style.color = 'var(--color-primary)';
                pomoStartBtn.textContent = 'START';
                updatePomoDisplay();
            }

            function startPomoInterval() {
                if (pomoInterval) clearInterval(pomoInterval);
                pomoStartBtn.textContent = 'PAUSE';

                pomoInterval = setInterval(() => {
                    pomoTimeLeft--;
                    updatePomoDisplay();

                    if (pomoTimeLeft <= 0) {
                        if (pomoCurrentMode === 'focus') {
                            startPomoBreak();
                        } else if (pomoCurrentMode === 'break') {
                            finishPomoBreak();
                        } else {
                            clearInterval(pomoInterval);
                            pomoInterval = null;
                            playAlarm();
                            alert('Timer Finished!');
                            pomoStartBtn.textContent = 'START';
                        }
                    }
                }, 1000);
            }

            pomoStartBtn.addEventListener('click', () => {
                if (pomoInterval) {
                    clearInterval(pomoInterval);
                    pomoInterval = null;
                    pomoStartBtn.textContent = 'RESUME';
                } else {
                    if (pomoTimeLeft <= 0) return;
                    startPomoInterval();
                }
            });

            pomoResetBtn.addEventListener('click', () => {
                if (pomoInterval) clearInterval(pomoInterval);
                pomoInterval = null;
                pomoTimeLeft = pomoTime;
                updatePomoDisplay();
                pomoStartBtn.textContent = 'START';
            });

            pomoFocusBtn.addEventListener('click', () => {
                pomoCurrentMode = 'focus';
                pomoTime = 25 * 60;
                pomoTimeLeft = pomoTime;
                pomoStatus.textContent = 'Focus Time';
                pomoStatus.style.color = 'var(--color-primary)';

                if (pomoInterval) clearInterval(pomoInterval);
                pomoInterval = null;
                pomoStartBtn.textContent = 'START';
                updatePomoDisplay();
            });

            pomoBreakBtn.addEventListener('click', () => {
                pomoCurrentMode = 'break';
                pomoTime = 5 * 60;
                pomoTimeLeft = pomoTime;
                pomoStatus.textContent = 'Break Time';
                pomoStatus.style.color = 'var(--color-accent)';

                if (pomoInterval) clearInterval(pomoInterval);
                pomoInterval = null;
                pomoStartBtn.textContent = 'START';
                updatePomoDisplay();
            });

            updatePomoDisplay(); // Init
        });
    </script>
</body>

</html>